<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ†Ô∏è –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã –¥–æ—Ä–æ–≥</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a1a;
      font-family: 'Courier New', monospace;
      color: #0f0;
      padding: 10px;
      overflow: hidden;
    }
    .container {
      display: flex;
      gap: 10px;
      height: calc(100vh - 20px);
    }
    .left-panel {
      width: 300px;
      background: rgba(0,0,0,0.95);
      border: 2px solid #0f0;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
    }
    .canvas-wrapper {
      flex: 1;
      position: relative;
      border: 3px solid #0f0;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }
    h1 {
      text-align: center;
      font-size: 16px;
      margin-bottom: 10px;
      color: #0ff;
    }
    .section {
      background: rgba(0,255,0,0.05);
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #0f0;
    }
    .section h3 {
      margin-bottom: 8px;
      color: #ff0;
      font-size: 12px;
    }
    button, label.btn {
      padding: 8px 12px;
      background: linear-gradient(135deg, #0f0, #0c0);
      color: #000;
      border: 2px solid #0f0;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 11px;
      width: 100%;
      margin-bottom: 5px;
      display: block;
      text-align: center;
    }
    button:hover { transform: scale(1.02); }
    input[type="file"] { display: none; }
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      margin-bottom: 5px;
    }
    .mode-btn {
      padding: 10px;
      font-size: 12px;
      cursor: pointer;
      border: 2px solid #666;
      background: rgba(0,0,0,0.5);
      color: #0f0;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, #0f0, #0c0);
      color: #000;
      border-color: #0f0;
    }
    .info {
      background: #000;
      padding: 8px;
      border-radius: 5px;
      font-size: 10px;
      margin-bottom: 8px;
    }
    .slider-group {
      margin-bottom: 8px;
    }
    .slider-group label {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      margin-bottom: 3px;
    }
    .value { color: #ff0; }
    input[type="range"] {
      width: 100%;
      height: 20px;
    }
    .checkbox {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 5px;
      font-size: 11px;
    }
    .checkbox input {
      width: 16px;
      height: 16px;
    }
    textarea {
      width: 100%;
      height: 100px;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      border-radius: 5px;
      padding: 5px;
      font-family: monospace;
      font-size: 10px;
      resize: vertical;
    }
    .node-list {
      max-height: 150px;
      overflow-y: auto;
      background: #000;
      padding: 5px;
      border-radius: 5px;
      font-size: 9px;
    }
    .node-item {
      padding: 3px;
      cursor: pointer;
      border-bottom: 1px solid #333;
    }
    .node-item:hover {
      background: rgba(0,255,0,0.1);
    }
    .node-item.selected {
      background: rgba(255,255,0,0.3);
      color: #ff0;
    }
    .help-text {
      font-size: 9px;
      color: #888;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <h1>üõ†Ô∏è –†–ï–î–ê–ö–¢–û–† –î–û–†–û–ì</h1>
      
      <!-- –†–ï–ñ–ò–ú -->
      <div class="section">
        <h3>üéØ –†–ï–ñ–ò–ú</h3>
        <div class="btn-group">
          <button class="mode-btn active" data-mode="view">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button class="mode-btn" data-mode="add">‚ûï –£–∑–µ–ª</button>
          <button class="mode-btn" data-mode="road">üõ£Ô∏è –î–æ—Ä–æ–≥–∞</button>
          <button class="mode-btn" data-mode="roundabout">‚≠ï –†–∞–∑–≤—è–∑–∫–∞</button>
          <button class="mode-btn" data-mode="delete">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
          <button class="mode-btn" data-mode="move">‚ÜîÔ∏è –î–≤–∏–≥–∞—Ç—å</button>
        </div>
        <div class="help-text" id="mode-help">
          –ü—Ä–æ—Å–º–æ—Ç—Ä: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ä—Ç—É
        </div>
      </div>

      <!-- –ó–ê–ì–†–£–ó–ö–ê -->
      <div class="section">
        <h3>üìÅ –ó–ê–ì–†–£–ó–ö–ê</h3>
        <label for="carpet" class="btn">üì∑ –ö–æ–≤–µ—Ä</label>
        <input type="file" id="carpet" accept="image/*">
        <label for="roads" class="btn" style="background: linear-gradient(135deg, #f0f, #c0c); border-color: #f0f;">
          üó∫Ô∏è road_system.js
        </label>
        <input type="file" id="roads" accept=".js">
        <div class="info" id="status">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
      </div>

      <!-- –£–ó–õ–´ -->
      <div class="section">
        <h3>üìç –£–ó–õ–´ (<span id="node-count">0</span>)</h3>
        <div class="node-list" id="node-list"></div>
        <button id="clear-nodes" style="background: linear-gradient(135deg, #f00, #c00); border-color: #f00;">
          üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
        </button>
      </div>

      <!-- –†–ê–ó–í–Ø–ó–ö–ò -->
      <div class="section">
        <h3>‚≠ï –†–ê–ó–í–Ø–ó–ö–ò (<span id="roundabout-count">0</span>)</h3>
        <div class="info" id="roundabout-list">–ù–µ—Ç —Ä–∞–∑–≤—è–∑–æ–∫</div>
        <button id="mark-roundabout">‚≠ï –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∫–∞–∫ —Ä–∞–∑–≤—è–∑–∫—É</button>
      </div>

      <!-- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø -->
      <div class="section">
        <h3>üé® –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï</h3>
        <div class="slider-group">
          <label><span>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:</span><span class="value" id="op-val">0.7</span></label>
          <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.7">
        </div>
        <div class="slider-group">
          <label><span>–®–∏—Ä–∏–Ω–∞:</span><span class="value" id="w-val">5</span></label>
          <input type="range" id="width" min="2" max="15" value="5">
        </div>
        <div class="checkbox">
          <input type="checkbox" id="show-nodes" checked>
          <label for="show-nodes">–£–∑–ª—ã</label>
        </div>
        <div class="checkbox">
          <input type="checkbox" id="show-roads" checked>
          <label for="show-roads">–î–æ—Ä–æ–≥–∏</label>
        </div>
        <div class="checkbox">
          <input type="checkbox" id="show-roundabouts" checked>
          <label for="show-roundabouts">–†–∞–∑–≤—è–∑–∫–∏</label>
        </div>
      </div>

      <!-- –≠–ö–°–ü–û–†–¢ -->
      <div class="section">
        <h3>üíæ –≠–ö–°–ü–û–†–¢</h3>
        <button id="export">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <textarea id="export-area" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∫–æ–¥..."></textarea>
      </div>
    </div>

    <div class="canvas-wrapper">
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let img = null;
    let nodes = [];
    let roads = [];
    let roundabouts = [];
    let selectedNodes = [];
    
    let mode = 'view';
    let opacity = 0.7, lineWidth = 5;
    let showNodes = true, showRoads = true, showRoundabouts = true;
    
    let dragStart = null;
    let offsetX = 0, offsetY = 0;
    let scale = 1.0;
    
    const modeHelp = {
      view: '–ü—Ä–æ—Å–º–æ—Ç—Ä: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ä—Ç—É, –∫–æ–ª–µ—Å–æ = –∑—É–º',
      add: '–£–∑–µ–ª: –∫–ª–∏–∫–∞–π—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —É–∑–ª—ã',
      road: '–î–æ—Ä–æ–≥–∞: –∫–ª–∏–∫–∞–π—Ç–µ –Ω–∞ 2 —É–∑–ª–∞ —á—Ç–æ–±—ã —Å–æ–µ–¥–∏–Ω–∏—Ç—å',
      roundabout: '–†–∞–∑–≤—è–∑–∫–∞: –∫–ª–∏–∫–∞–π—Ç–µ —É–∑–ª—ã –ø–æ –∫—Ä—É–≥—É, Enter = –∑–∞–º–∫–Ω—É—Ç—å',
      delete: '–£–¥–∞–ª–∏—Ç—å: –∫–ª–∏–∫–∞–π—Ç–µ –Ω–∞ —É–∑–ª—ã/–¥–æ—Ä–æ–≥–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è',
      move: '–î–≤–∏–≥–∞—Ç—å: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —É–∑–ª—ã'
    };
    
    let tempRoundabout = [];

    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      draw();
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function toCanvas(x, y) {
      const cx = ((parseFloat(x) + 1.0) / 2.0) * 1000;
      const cy = ((1.2 - parseFloat(y)) / 2.4) * 1200;
      return {
        x: cx * scale + offsetX,
        y: cy * scale + offsetY
      };
    }

    function fromCanvas(cx, cy) {
      const nx = (cx - offsetX) / scale;
      const ny = (cy - offsetY) / scale;
      const x = (nx / 1000) * 2.0 - 1.0;
      const y = 1.2 - (ny / 1200) * 2.4;
      return { x: x.toFixed(2), y: y.toFixed(2) };
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#222';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.save();
      
      if (img && img.complete) {
        const w = 1000 * scale;
        const h = 1200 * scale;
        ctx.drawImage(img, offsetX, offsetY, w, h);
      }

      // –î–æ—Ä–æ–≥–∏
      if (showRoads && roads.length > 0) {
        ctx.globalAlpha = opacity;
        ctx.strokeStyle = '#f00';
        ctx.lineWidth = lineWidth;
        ctx.lineCap = 'round';
        
        roads.forEach(road => {
          const p1 = toCanvas(road.from.x, road.from.y);
          const p2 = toCanvas(road.to.x, road.to.y);
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.stroke();
        });
        ctx.globalAlpha = 1;
      }

      // –†–∞–∑–≤—è–∑–∫–∏
      if (showRoundabouts && roundabouts.length > 0) {
        ctx.strokeStyle = '#ff0';
        ctx.lineWidth = lineWidth;
        roundabouts.forEach(rb => {
          ctx.beginPath();
          rb.forEach((node, i) => {
            const p = toCanvas(node.x, node.y);
            if (i === 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
          });
          ctx.closePath();
          ctx.stroke();
          
          // –¶–µ–Ω—Ç—Ä
          if (rb.length > 0) {
            const center = rb[Math.floor(rb.length / 2)];
            const p = toCanvas(center.x, center.y);
            ctx.fillStyle = '#0ff';
            ctx.beginPath();
            ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
            ctx.fill();
          }
        });
      }

      // –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–∞–∑–≤—è–∑–∫–∞
      if (tempRoundabout.length > 0) {
        ctx.strokeStyle = '#0f0';
        ctx.lineWidth = lineWidth;
        ctx.beginPath();
        tempRoundabout.forEach((node, i) => {
          const p = toCanvas(node.x, node.y);
          if (i === 0) ctx.moveTo(p.x, p.y);
          else ctx.lineTo(p.x, p.y);
        });
        ctx.stroke();
      }

      // –£–∑–ª—ã
      if (showNodes) {
        nodes.forEach((node, i) => {
          const p = toCanvas(node.x, node.y);
          const isSelected = selectedNodes.includes(i);
          
          ctx.fillStyle = isSelected ? '#ff0' : '#0f0';
          ctx.beginPath();
          ctx.arc(p.x, p.y, isSelected ? 6 : 4, 0, Math.PI * 2);
          ctx.fill();
          
          // –ù–æ–º–µ—Ä
          ctx.fillStyle = '#fff';
          ctx.font = '10px monospace';
          ctx.fillText(i, p.x + 8, p.y - 8);
        });
      }

      ctx.restore();
      updateUI();
    }

    function updateUI() {
      document.getElementById('node-count').textContent = nodes.length;
      document.getElementById('roundabout-count').textContent = roundabouts.length;
      
      const nodeList = document.getElementById('node-list');
      nodeList.innerHTML = nodes.map((n, i) => 
        `<div class="node-item ${selectedNodes.includes(i) ? 'selected' : ''}" data-idx="${i}">
          ${i}: (${n.x}, ${n.y})
        </div>`
      ).join('');
      
      document.getElementById('roundabout-list').textContent = 
        roundabouts.length > 0 ? 
        roundabouts.map((r, i) => `–†–∞–∑–≤—è–∑–∫–∞ ${i + 1}: ${r.length} —É–∑–ª–æ–≤`).join(', ') :
        '–ù–µ—Ç —Ä–∞–∑–≤—è–∑–æ–∫';
    }

    function findNodeAt(cx, cy) {
      const threshold = 10;
      for (let i = 0; i < nodes.length; i++) {
        const p = toCanvas(nodes[i].x, nodes[i].y);
        const dist = Math.hypot(p.x - cx, p.y - cy);
        if (dist < threshold) return i;
      }
      return -1;
    }

    // –°–æ–±—ã—Ç–∏—è
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        mode = btn.dataset.mode;
        document.getElementById('mode-help').textContent = modeHelp[mode];
        selectedNodes = [];
        tempRoundabout = [];
        draw();
      };
    });

    canvas.onmousedown = (e) => {
      const rect = canvas.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;
      
      if (mode === 'view') {
        dragStart = { x: cx - offsetX, y: cy - offsetY };
      } else if (mode === 'add') {
        const coords = fromCanvas(cx, cy);
        nodes.push(coords);
        draw();
      } else if (mode === 'road') {
        const idx = findNodeAt(cx, cy);
        if (idx >= 0) {
          if (selectedNodes.length === 0) {
            selectedNodes.push(idx);
          } else if (selectedNodes.length === 1) {
            roads.push({ from: nodes[selectedNodes[0]], to: nodes[idx] });
            selectedNodes = [];
          }
          draw();
        }
      } else if (mode === 'roundabout') {
        const idx = findNodeAt(cx, cy);
        if (idx >= 0 && !tempRoundabout.includes(nodes[idx])) {
          tempRoundabout.push(nodes[idx]);
          draw();
        }
      } else if (mode === 'delete') {
        const idx = findNodeAt(cx, cy);
        if (idx >= 0) {
          nodes.splice(idx, 1);
          roads = roads.filter(r => r.from !== nodes[idx] && r.to !== nodes[idx]);
          draw();
        }
      }
    };

    canvas.onmousemove = (e) => {
      if (mode === 'view' && dragStart) {
        const rect = canvas.getBoundingClientRect();
        const cx = e.clientX - rect.left;
        const cy = e.clientY - rect.top;
        offsetX = cx - dragStart.x;
        offsetY = cy - dragStart.y;
        draw();
      }
    };

    canvas.onmouseup = () => {
      dragStart = null;
    };

    canvas.onwheel = (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      scale = Math.max(0.1, Math.min(5, scale * delta));
      draw();
    };

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && mode === 'roundabout' && tempRoundabout.length >= 3) {
        roundabouts.push([...tempRoundabout]);
        tempRoundabout = [];
        draw();
      }
    });

    document.getElementById('carpet').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          img = new Image();
          img.onload = () => {
            document.getElementById('status').textContent = '‚úÖ –ö–æ–≤–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω';
            draw();
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }
    };

    document.getElementById('roads').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const code = ev.target.result;
            // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –º–∞—Å—Å–∏–≤–æ–≤ —É–∑–ª–æ–≤
            const matches = code.matchAll(/\{\s*x:\s*([-\d.]+),\s*y:\s*([-\d.]+)\s*\}/g);
            nodes = [];
            for (const match of matches) {
              nodes.push({ x: match[1], y: match[2] });
            }
            document.getElementById('status').textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${nodes.length} —É–∑–ª–æ–≤`;
            draw();
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + err.message);
          }
        };
        reader.readAsText(file);
      }
    };

    document.getElementById('node-list').onclick = (e) => {
      const item = e.target.closest('.node-item');
      if (item) {
        const idx = parseInt(item.dataset.idx);
        if (selectedNodes.includes(idx)) {
          selectedNodes = selectedNodes.filter(i => i !== idx);
        } else {
          selectedNodes.push(idx);
        }
        draw();
      }
    };

    document.getElementById('mark-roundabout').onclick = () => {
      if (selectedNodes.length >= 3) {
        const rb = selectedNodes.map(i => nodes[i]);
        roundabouts.push(rb);
        selectedNodes = [];
        draw();
      } else {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —É–∑–ª–∞');
      }
    };

    document.getElementById('clear-nodes').onclick = () => {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —É–∑–ª—ã –∏ –¥–æ—Ä–æ–≥–∏?')) {
        nodes = [];
        roads = [];
        roundabouts = [];
        selectedNodes = [];
        draw();
      }
    };

    document.getElementById('opacity').oninput = (e) => {
      opacity = parseFloat(e.target.value);
      document.getElementById('op-val').textContent = opacity.toFixed(1);
      draw();
    };

    document.getElementById('width').oninput = (e) => {
      lineWidth = parseInt(e.target.value);
      document.getElementById('w-val').textContent = lineWidth;
      draw();
    };

    document.getElementById('show-nodes').onchange = (e) => {
      showNodes = e.target.checked;
      draw();
    };

    document.getElementById('show-roads').onchange = (e) => {
      showRoads = e.target.checked;
      draw();
    };

    document.getElementById('show-roundabouts').onchange = (e) => {
      showRoundabouts = e.target.checked;
      draw();
    };

    document.getElementById('export').onclick = () => {
      const code = `// road_system.js - –≠–∫—Å–ø–æ—Ä—Ç –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
// –£–∑–ª–æ–≤: ${nodes.length}, –î–æ—Ä–æ–≥: ${roads.length}, –†–∞–∑–≤—è–∑–æ–∫: ${roundabouts.length}

const allNodes = [
${nodes.map(n => `  { x: ${n.x}, y: ${n.y} }`).join(',\n')}
];

const roads = [
${roads.map(r => {
  const fromIdx = nodes.indexOf(r.from);
  const toIdx = nodes.indexOf(r.to);
  return `  { from: ${fromIdx}, to: ${toIdx} }`;
}).join(',\n')}
];

const roundabouts = [
${roundabouts.map(rb => {
  const indices = rb.map(n => nodes.indexOf(n));
  return `  [${indices.join(', ')}]`;
}).join(',\n')}
];`;
      
      document.getElementById('export-area').value = code;
      navigator.clipboard.writeText(code);
      alert('‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!');
    };

    draw();
  </script>
</body>
</html>